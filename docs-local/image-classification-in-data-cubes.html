<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Image Classification in Data Cubes | sits: Satellite Image Time Series Analysis on Earth Observation Data Cubes</title>
<meta name="author" content="Gilberto Camara">
<meta name="author" content="Rolf Simoes">
<meta name="author" content="Felipe Souza">
<meta name="author" content="Charlotte Pelletier">
<meta name="author" content="Alber Sanchez">
<meta name="author" content="Pedro Ribeiro Andrade">
<meta name="author" content="Karine Ferreira">
<meta name="author" content="Gilberto Queiroz">
<meta name="description" content="In this chapter, we discuss how to classify data cubes by providing a step-by-step example. Our study area is the state of Rondonia, Brazil, that underwent substantial deforestation in the last...">
<meta name="generator" content="bookdown 0.32 with bs4_book()">
<meta property="og:title" content="Image Classification in Data Cubes | sits: Satellite Image Time Series Analysis on Earth Observation Data Cubes">
<meta property="og:type" content="book">
<meta property="og:image" content="/images/cover_sits_book.png">
<meta property="og:description" content="In this chapter, we discuss how to classify data cubes by providing a step-by-step example. Our study area is the state of Rondonia, Brazil, that underwent substantial deforestation in the last...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Image Classification in Data Cubes | sits: Satellite Image Time Series Analysis on Earth Observation Data Cubes">
<meta name="twitter:description" content="In this chapter, we discuss how to classify data cubes by providing a step-by-step example. Our study area is the state of Rondonia, Brazil, that underwent substantial deforestation in the last...">
<meta name="twitter:image" content="/images/cover_sits_book.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/IBM_Plex_Serif-0.4.5/font.css" rel="stylesheet">
<link href="libs/IBM_Plex_Mono-0.4.5/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title=""><strong>sits</strong>: Satellite Image Time Series Analysis on Earth Observation Data Cubes</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="setup.html">Setup</a></li>
<li><a class="" href="acknowledgements.html">Acknowledgements</a></li>
<li><a class="" href="introduction-to-sits.html">Introduction to SITS</a></li>
<li><a class="" href="earth-observation-data-cubes.html">Earth observation data cubes</a></li>
<li><a class="" href="operations-on-data-cubes.html">Operations on Data Cubes</a></li>
<li><a class="" href="working-with-time-series.html">Working with time series</a></li>
<li><a class="" href="improving-the-quality-of-training-samples.html">Improving the Quality of Training Samples</a></li>
<li><a class="" href="machine-learning-for-data-cubes.html">Machine Learning for Data Cubes</a></li>
<li><a class="active" href="image-classification-in-data-cubes.html">Image Classification in Data Cubes</a></li>
<li><a class="" href="bayesian-smoothing-for-post-processing.html">Bayesian smoothing for post-processing</a></li>
<li><a class="" href="validation-and-accuracy-measurements.html">Validation and accuracy measurements</a></li>
<li><a class="" href="uncertainty-and-active-learning.html">Uncertainty and active learning</a></li>
<li><a class="" href="ensemble-prediction-from-multiple-models.html">Ensemble Prediction from Multiple Models</a></li>
<li><a class="" href="visualising-and-exporting-data.html">Visualising and Exporting data</a></li>
<li><a class="" href="technical-annex.html">Technical Annex</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="image-classification-in-data-cubes" class="section level1 unnumbered">
<h1>Image Classification in Data Cubes<a class="anchor" aria-label="anchor" href="#image-classification-in-data-cubes"><i class="fas fa-link"></i></a>
</h1>
<p><a href="https://www.kaggle.com/esensing/raster-classification-in-sits" target="_blank"><img src="https://kaggle.com/static/images/open-in-kaggle.svg"></a></p>
<p>In this chapter, we discuss how to classify data cubes by providing a step-by-step example. Our study area is the state of Rondonia, Brazil, that underwent substantial deforestation in the last decades. The objective of the case study is to detect deforested areas.</p>
<div id="training-the-classification-model" class="section level2 unnumbered">
<h2>Training the classification model<a class="anchor" aria-label="anchor" href="#training-the-classification-model"><i class="fas fa-link"></i></a>
</h2>
<p>The case study uses the training data set <code>samples_prodes_4bands</code>, available in package <code>sitsdata</code>. This data set consists of 480 samples collected from Sentinel-2 images covering the state of Rondonia. The samples are intended to detect deforestation events, and include four classes: “Forest”, “Burned_Area”, “Cleared_Area”, and “Highly_Degraded”. The time series cover a set of 29 dates with a period of 16 days, ranging from “2020-06-04” to “2021-08-26”. The data has 12 attributes, including original bands (“B02”, “B03”, “B04”, “B05”, “B08”, “B8A”, “B11”, and “B12”) and indices (“NDVI”, “EVI” and “NBR”).</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/e-sensing/sitsdata/">sitsdata</a></span><span class="op">)</span></span>
<span><span class="co"># obtain the samples</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"samples_prodes_4classes"</span><span class="op">)</span></span>
<span><span class="co"># show the contents of the samples</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_labels_summary.html">sits_labels_summary</a></span><span class="op">(</span><span class="va">samples_prodes_4classes</span><span class="op">)</span></span></code></pre></div>
<pre class="sourceCode"><code>#&gt; # A tibble: 4 × 3
#&gt;   label           count  prop
#&gt;   &lt;chr&gt;           &lt;int&gt; &lt;dbl&gt;
#&gt; 1 Burned_Area        96 0.244
#&gt; 2 Cleared_Area      115 0.293
#&gt; 3 Forest            107 0.272
#&gt; 4 Highly_Degraded    75 0.191</code></pre>
<p>To better understand the training set, its is useful to plot the basic patterns associated to the samples. The function <code><a href="https://rdrr.io/pkg/sits/man/sits_patterns.html">sits_patterns()</a></code> uses a generalized additive model (GAM) to predict a smooth, idealized approximation to the time series associated to the each label, for all bands. Since the data cube used in the classification has only three bands (“B02”, “B8A”, and “B11”), we filter the samples for these bands before showing the patterns.</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples_3bands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_select.html">sits_select</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">samples_prodes_4classes</span>,</span>
<span>  bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B02"</span>, <span class="st">"B8A"</span>, <span class="st">"B11"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_patterns.html">sits_patterns</a></span><span class="op">(</span><span class="va">samples_3bands</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-110"></span>
<img src="sitsbook_files/figure-html/unnamed-chunk-110-1.png" alt="Patterns associated to the training samples" width="90%"><p class="caption">
Figure 62: Patterns associated to the training samples
</p>
</div>
<p>The patterns show different temporal responses for the selected classes. They match the typical behavior of deforestation in the Amazon. First, the forest is cut at the start of the dry season (June/July). At the end of the dry season, some clear-cut areas are burned to clean the remains; this action is reflected in the steep fall of the response of “B8A” values of burned area samples after July. In areas that are cleared but not burned, response in the middle infra-red band “B11” increases significantly at the end of the dry season, while “B8A” values remain high. This is a sign of mixed pixels which combine forest remains with bare soil. Forest areas show a constant spectral response during the year. Degraded areas show an increase in values of middle infra-red band “B11” compared to native forests, showing a mixed response of vegetation and soil.</p>
</div>
<div id="building-a-data-cube" class="section level2 unnumbered">
<h2>Building a data cube<a class="anchor" aria-label="anchor" href="#building-a-data-cube"><i class="fas fa-link"></i></a>
</h2>
<p>We now build a data cube from the Sentinel-2 images available in the package <code>sitsdata</code>. These images were downloaded from the <code>SENTINEL-2-L2A</code> collection in Microsoft Planetary Computer (<code>MPC</code>). We have chosen bands “BO2”, “B8A” and “B11” images in a small area of 1000 x 1000 pixels the state of Rondonia. As explained in the “Earth observation data cubes” chapter, we need to inform <code>sits</code> how to parse these file names to obtain tile, date and band information. Image files are named according to the convention “cube_tile_band_date” (e.g., <code>cube_20LKP_BO2_2020_06_04.tif</code>).</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># files are available in a local directory</span></span>
<span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/Rondonia-20LKP/"</span>, package <span class="op">=</span> <span class="st">"sitsdata"</span><span class="op">)</span></span>
<span><span class="co"># read data cube</span></span>
<span><span class="va">ro_cube_20LKP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_cube.html">sits_cube</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"MPC"</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"SENTINEL-2-L2A"</span>,</span>
<span>  data_dir <span class="op">=</span> <span class="va">data_dir</span>,</span>
<span>  parse_info <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X1"</span>, <span class="st">"tile"</span>, <span class="st">"band"</span>, <span class="st">"date"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the cube</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ro_cube_20LKP</span>, dates <span class="op">=</span> <span class="st">"2021-07-25"</span>, red <span class="op">=</span> <span class="st">"B11"</span>, green <span class="op">=</span> <span class="st">"B8A"</span>, blue <span class="op">=</span> <span class="st">"B02"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-111"></span>
<img src="sitsbook_files/figure-html/unnamed-chunk-111-1.png" alt="Color composite image of the cube for date 2021-07-25" width="90%"><p class="caption">
Figure 63: Color composite image of the cube for date 2021-07-25
</p>
</div>
</div>
<div id="training-a-deep-learning-model" class="section level2 unnumbered">
<h2>Training a deep learning model<a class="anchor" aria-label="anchor" href="#training-a-deep-learning-model"><i class="fas fa-link"></i></a>
</h2>
<p>The next step is to train a Lightweigth Temporal Attentiona Enconder model model, using the <code>adamw</code> optimizer and a learning rate of 0.001. Since the data cube to be classified has bands <code>BO2</code>, <code>B8A</code> and <code>B11</code>, we select these bands from the training data.</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># use only the bands available in the cube</span></span>
<span><span class="va">samples_3bands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_select.html">sits_select</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">samples_prodes_4classes</span>,</span>
<span>  bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_bands.html">sits_bands</a></span><span class="op">(</span><span class="va">ro_cube_20LKP</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># train model using LightTAE algorithm</span></span>
<span><span class="va">ltae_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_train.html">sits_train</a></span><span class="op">(</span></span>
<span>  samples <span class="op">=</span> <span class="va">samples_3bands</span>,</span>
<span>  ml_method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_lighttae.html">sits_lighttae</a></span><span class="op">(</span></span>
<span>    opt_hparams <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lr <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># plot the evolution of the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ltae_model</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-112"></span>
<img src="sitsbook_files/figure-html/unnamed-chunk-112-1.png" alt="Training evolution of LightTAE model." width="80%"><p class="caption">
Figure 64: Training evolution of LightTAE model.
</p>
</div>
</div>
<div id="classification-using-parallel-processing" class="section level2 unnumbered">
<h2>Classification using parallel processing<a class="anchor" aria-label="anchor" href="#classification-using-parallel-processing"><i class="fas fa-link"></i></a>
</h2>
<p>To classify both data cubes and sets of time series, use the function <code><a href="https://rdrr.io/pkg/sits/man/sits_classify.html">sits_classify()</a></code>, which uses parallel processing for speed up performance, as described in the end of this Chapter. Its most relevant parameters are: (a) <code>data</code>, either a data cube or a set of time series; (b) <code>ml_model</code>, a trained model using one of the machine learning methods provided; (c) <code>multicores</code>, number of CPU cores that will be used for processing; (d) <code>memsize</code>, memory available for classification; (e) <code>output_dir</code>, directory where results will be stored; (f) <code>version</code>, for version control. If users want to follow the processing steps, they should turn on the parameters <code>verbose</code> to print information and <code>progress</code> to get a progress bar. The result of the classification is a data cube with a set of probability layers, one for each output class. Each probability layer contains the model’s assessment of how likely is each pixel to belong to the related class. The probability cube can be visualized with <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code>.</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># classify data cube</span></span>
<span><span class="va">ro_cube_20LKP_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_classify.html">sits_classify</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">ro_cube_20LKP</span>,</span>
<span>  ml_model <span class="op">=</span> <span class="va">ltae_model</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"./tempdir/chp9"</span>,</span>
<span>  version <span class="op">=</span> <span class="st">"ltae"</span>,</span>
<span>  multicores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  memsize <span class="op">=</span> <span class="fl">12</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ro_cube_20LKP_probs</span>, palette <span class="op">=</span> <span class="st">"YlGn"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-113"></span>
<img src="sitsbook_files/figure-html/unnamed-chunk-113-1.png" alt="Probability maps produced by LightTAE model." width="80%"><p class="caption">
Figure 65: Probability maps produced by LightTAE model.
</p>
</div>
<p>The probability cube is a useful tool for data analysis. It is used for post-processing smoothing, as described in this Chapter, but also in uncertainty estimates and active learning, as described in the “Uncertainty and Active Learning” Chapter.</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generate thematic map</span></span>
<span><span class="va">defor_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_label_classification.html">sits_label_classification</a></span><span class="op">(</span></span>
<span>  cube <span class="op">=</span> <span class="va">ro_cube_20LKP_probs</span>,</span>
<span>  multicores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  memsize <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"./tempdir/chp9"</span>,</span>
<span>  version <span class="op">=</span> <span class="st">"no_smooth"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">defor_map</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-114"></span>
<img src="sitsbook_files/figure-html/unnamed-chunk-114-1.png" alt="Final classification map." width="100%"><p class="caption">
Figure 66: Final classification map.
</p>
</div>
<p>The labelled map generated from the pixel-based time series classification method exhibits a number of misclassified pixels, which are depicted as small patches that appear surrounded by a different class. This occurrence of outliers is a common issue that arises due to the inherent nature of this classification approach. Mixed pixels are prevalent in images, regardless of their resolution, and each class exhibits a considerable degree of data variability. As a result, these factors can lead to outliers that have a higher probability of being misclassified. To overcome this limitation, <code>sits</code> employs post-processing smoothing techniques that leverage the spatial context of the probability cubes to refine the results. These techniques will be discussed in the next chapter.</p>
</div>
<div id="map-reclassification" class="section level2 unnumbered">
<h2>Map Reclassification<a class="anchor" aria-label="anchor" href="#map-reclassification"><i class="fas fa-link"></i></a>
</h2>
<p>Reclassification of a remote sensing map refers to the process of changing the classes assigned to different pixels in the image. The purpose of reclassification is to modify the information contained in the image to better suit a specific use case. In <code>sits</code>, reclassification involves assigning new class labels to pixels based on additional information provided a reference map. Based on the labels of the classification and the reference map, the users defines rules based on the desired outcome. These rules are then applied to the classified map. The result is a new map with updated labels.</p>
<p>To illustrate the reclassification operation in <code>sits</code>, we take a classified data cube, stored in the <code>sitsdata</code> package. As discussed in the “Earth observation data cubes” chapter, <code>sits</code> can create a data cube from a classified image file. Users need to provide the original data source and collection, the directory where data is stored (<code>data_dir</code>), the information on how to retrieve data cube parameters from file names (<code>parse_info</code>), and the labels associated to the classified image.</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Open classification map</span></span>
<span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/Rondonia-Class"</span>, package <span class="op">=</span> <span class="st">"sitsdata"</span><span class="op">)</span></span>
<span><span class="va">ro_class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_cube.html">sits_cube</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"MPC"</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"SENTINEL-2-L2A"</span>,</span>
<span>  data_dir <span class="op">=</span> <span class="va">data_dir</span>,</span>
<span>  parse_info <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"tile"</span>, <span class="st">"start_date"</span>, <span class="st">"end_date"</span>,</span>
<span>    <span class="st">"band"</span>, <span class="st">"version"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  bands <span class="op">=</span> <span class="st">"class"</span>,</span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Water"</span>, <span class="st">"ClearCut_Burn"</span>, <span class="st">"ClearCut_Soil"</span>,</span>
<span>    <span class="st">"ClearCut_Veg"</span>, <span class="st">"Forest"</span>, <span class="st">"Bare_Soil"</span>, <span class="st">"Wetland"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ro_class</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-115"></span>
<img src="sitsbook_files/figure-html/unnamed-chunk-115-1.png" alt="original classification map." width="100%"><p class="caption">
Figure 67: original classification map.
</p>
</div>
<p>The above map shows the total extent of deforestation by clear cuts estimated by the <code>sits</code> random forest algorithm in an area in Rondonia, Brasil, based on an time series of Sentinel-2 images for the period <code>2020-06-04</code> to <code>2021-08-26</code>. Suppose we want to estimate the deforestation that ocurred period from June 2020 to August 2021. We need a reference map that contains information on forest cuts prior to 2020.</p>
<p>In this example, we the PRODES deforestation map of Amazonia created by Brazil’s National Institute for Space Research (INPE) as our refence. This map is produced by visual interpretation. PRODES measures deforestation on an yearly basis, starting from August of one year to July of the following year. The contains classes that represent the natural world (“Forest”, “Water”, “NonForest”, and “NonForest2”) and classes that capture the yearly deforestation increments. These classes are labelled “dYYYY” and “rYYYY”; the first label refers to deforestation on a given year (e.g., “d2008” for deforestation for August 2007 to July 2008); the second to places where the satellite data is not sufficient to determine the land cover (e.g, “r2010” for 2010). This map is available on package “sitsdata”, as shown below.</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/PRODES"</span>, package <span class="op">=</span> <span class="st">"sitsdata"</span><span class="op">)</span></span>
<span><span class="va">prodes2021</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_cube.html">sits_cube</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"USGS"</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"LANDSAT-C2L2-SR"</span>,</span>
<span>  data_dir <span class="op">=</span> <span class="va">data_dir</span>,</span>
<span>  parse_info <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"tile"</span>, <span class="st">"start_date"</span>, <span class="st">"end_date"</span>,</span>
<span>    <span class="st">"band"</span>, <span class="st">"version"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  bands <span class="op">=</span> <span class="st">"class"</span>,</span>
<span>  version <span class="op">=</span> <span class="st">"v20220606"</span>,</span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Forest"</span>, <span class="st">"Water"</span>, <span class="st">"NonForest"</span>,</span>
<span>    <span class="st">"NonForest2"</span>, <span class="st">"NoClass"</span>, <span class="st">"d2007"</span>, <span class="st">"d2008"</span>,</span>
<span>    <span class="st">"d2009"</span>, <span class="st">"d2010"</span>, <span class="st">"d2011"</span>, <span class="st">"d2012"</span>,</span>
<span>    <span class="st">"d2013"</span>, <span class="st">"d2014"</span>, <span class="st">"d2015"</span>, <span class="st">"d2016"</span>,</span>
<span>    <span class="st">"d2017"</span>, <span class="st">"d2018"</span>, <span class="st">"r2010"</span>, <span class="st">"r2011"</span>,</span>
<span>    <span class="st">"r2012"</span>, <span class="st">"r2013"</span>, <span class="st">"r2014"</span>, <span class="st">"r2015"</span>,</span>
<span>    <span class="st">"r2016"</span>, <span class="st">"r2017"</span>, <span class="st">"r2018"</span>, <span class="st">"d2019"</span>,</span>
<span>    <span class="st">"r2019"</span>, <span class="st">"d2020"</span>, <span class="st">"NoClass"</span>, <span class="st">"r2020"</span>,</span>
<span>    <span class="st">"Clouds2021"</span>, <span class="st">"d2021"</span>, <span class="st">"r2021"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Since the labels of the deforestation map are specialized and are not part of the default <code>sits</code> color table, we define a legend for better visualisation of the different deforestation classes. Using this new legend, we can plot the PRODES deforestation map.</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># use the RColorBrewer pallete "YlOrBr" for the deforestation years</span></span>
<span><span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">hcl.colors</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">15</span>, palette <span class="op">=</span> <span class="st">"YlOrBr"</span><span class="op">)</span></span>
<span><span class="co"># define the legend for the deforestation map</span></span>
<span><span class="va">def_legend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"Forest"</span> <span class="op">=</span> <span class="st">"forestgreen"</span>, <span class="st">"Water"</span> <span class="op">=</span> <span class="st">"dodgerblue3"</span>,</span>
<span>  <span class="st">"NonForest"</span> <span class="op">=</span> <span class="st">"bisque2"</span>, <span class="st">"NonForest2"</span> <span class="op">=</span> <span class="st">"bisque2"</span>,</span>
<span>  <span class="st">"d2007"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"d2008"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>  <span class="st">"d2009"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="st">"d2010"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,</span>
<span>  <span class="st">"d2011"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">5</span><span class="op">]</span>, <span class="st">"d2012"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span>,</span>
<span>  <span class="st">"d2013"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">7</span><span class="op">]</span>, <span class="st">"d2014"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">8</span><span class="op">]</span>,</span>
<span>  <span class="st">"d2015"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">9</span><span class="op">]</span>, <span class="st">"d2016"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span>,</span>
<span>  <span class="st">"d2017"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span>, <span class="st">"d2018"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">12</span><span class="op">]</span>,</span>
<span>  <span class="st">"d2019"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">13</span><span class="op">]</span>, <span class="st">"d2020"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">14</span><span class="op">]</span>,</span>
<span>  <span class="st">"d2021"</span> <span class="op">=</span> <span class="va">colors</span><span class="op">[</span><span class="fl">15</span><span class="op">]</span>, <span class="st">"r2010"</span> <span class="op">=</span> <span class="st">"azure2"</span>,</span>
<span>  <span class="st">"r2011"</span> <span class="op">=</span> <span class="st">"azure2"</span>, <span class="st">"r2012"</span> <span class="op">=</span> <span class="st">"azure2"</span>,</span>
<span>  <span class="st">"r2013"</span> <span class="op">=</span> <span class="st">"azure2"</span>, <span class="st">"r2014"</span> <span class="op">=</span> <span class="st">"azure2"</span>,</span>
<span>  <span class="st">"r2015"</span> <span class="op">=</span> <span class="st">"azure2"</span>, <span class="st">"r2016"</span> <span class="op">=</span> <span class="st">"azure2"</span>,</span>
<span>  <span class="st">"r2017"</span> <span class="op">=</span> <span class="st">"azure2"</span>, <span class="st">"r2018"</span> <span class="op">=</span> <span class="st">"azure2"</span>,</span>
<span>  <span class="st">"r2019"</span> <span class="op">=</span> <span class="st">"azure2"</span>, <span class="st">"r2020"</span> <span class="op">=</span> <span class="st">"azure2"</span>,</span>
<span>  <span class="st">"r2021"</span> <span class="op">=</span> <span class="st">"azure2"</span>, <span class="st">"NoClass"</span> <span class="op">=</span> <span class="st">"grey90"</span>,</span>
<span>  <span class="st">"Clouds2021"</span> <span class="op">=</span> <span class="st">"grey90"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">prodes2021</span>, legend <span class="op">=</span> <span class="va">def_legend</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-117"></span>
<img src="sitsbook_files/figure-html/unnamed-chunk-117-1.png" alt="Deforestation map produced by PRODES." width="100%"><p class="caption">
Figure 68: Deforestation map produced by PRODES.
</p>
</div>
<p>Taking the PRODES map as our refence, we can include new labels in the classified map produced by <code>sits</code> using <code><a href="https://rdrr.io/pkg/sits/man/sits_reclassify.html">sits_reclassify()</a></code>. The new label “Defor_2020” will be applied to all pixels that PRODES considers that have been deforested prior to July 2020. We also include a new label “Non_Forest” to include all pixels that PRODES takes as not covered by native vegetation, such as wetlands and rocky areas. The PRODES classes will be used as a mask over the <code>sits</code> deforestation map.</p>
<p>The <code><a href="https://rdrr.io/pkg/sits/man/sits_reclassify.html">sits_reclassify()</a></code> operation requires the parameters: (a) <code>cube</code>, the classified data cube whose pixels will be reclassified; (b) <code>mask</code>, the reference data cube used as a mask; (c) <code>rules</code>, a named list. The names of the <code>rules</code> list will be the new labels of the classified cube. Each new label is associated to a <code>mask</code> vector that includes the labels of the reference map that will be joined. <code><a href="https://rdrr.io/pkg/sits/man/sits_reclassify.html">sits_reclassify()</a></code> then compares the original and reference map pixel by pixel. For each pixel of the reference map whose labels in one of the <code>rules</code>, the algorithm relabels the original map. The result will be a reclassified map that has the original labels plus the new labels that have been masked using the reference map.</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reclassify cube</span></span>
<span><span class="va">ro_def_2021</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_reclassify.html">sits_reclassify</a></span><span class="op">(</span></span>
<span>  cube <span class="op">=</span> <span class="va">ro_class</span>,</span>
<span>  mask <span class="op">=</span> <span class="va">prodes2021</span>,</span>
<span>  rules <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Deforestation_Mask"</span> <span class="op">=</span> <span class="va">mask</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"d2007"</span>, <span class="st">"d2008"</span>, <span class="st">"d2009"</span>,</span>
<span>      <span class="st">"d2010"</span>, <span class="st">"d2011"</span>, <span class="st">"d2012"</span>,</span>
<span>      <span class="st">"d2013"</span>, <span class="st">"d2014"</span>, <span class="st">"d2015"</span>,</span>
<span>      <span class="st">"d2016"</span>, <span class="st">"d2017"</span>, <span class="st">"d2018"</span>,</span>
<span>      <span class="st">"d2019"</span>, <span class="st">"d2020"</span>,</span>
<span>      <span class="st">"r2010"</span>, <span class="st">"r2011"</span>, <span class="st">"r2012"</span>,</span>
<span>      <span class="st">"r2013"</span>, <span class="st">"r2014"</span>, <span class="st">"r2015"</span>,</span>
<span>      <span class="st">"r2016"</span>, <span class="st">"r2017"</span>, <span class="st">"r2018"</span>,</span>
<span>      <span class="st">"r2019"</span>, <span class="st">"r2020"</span>, <span class="st">"r2021"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="st">"Water"</span> <span class="op">=</span> <span class="va">mask</span> <span class="op">==</span> <span class="st">"Water"</span>,</span>
<span>    <span class="st">"Non_Forest"</span> <span class="op">=</span> <span class="va">mask</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NonForest"</span>, <span class="st">"NonForest2"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  memsize <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  multicores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"./tempdir/chp9"</span>,</span>
<span>  version <span class="op">=</span> <span class="st">"reclass"</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># plot the reclassified map</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ro_def_2021</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-118"></span>
<img src="sitsbook_files/figure-html/unnamed-chunk-118-1.png" alt="Deforestation map by sits masked by PRODES map." width="100%"><p class="caption">
Figure 69: Deforestation map by sits masked by PRODES map.
</p>
</div>
<p>The reclassified map has been split into deforestation prior to mid-2020 (using the PRODES map) and the areas classified by <code>sits</code> that are taken as being deforested on the period mid-2020 to mid-2021. This allows the experts to measure how much deforestation occurred in this period according to <code>sits</code> and compare the result with that of the PRODES visual interpretation map.</p>
<p>The <code><a href="https://rdrr.io/pkg/sits/man/sits_reclassify.html">sits_reclassify()</a></code> operation is not restricted to the comparison between deforestation maps. It can be used in any case that requires masking of a result based on a reference map.</p>
</div>
<div id="how-parallel-processing-works" class="section level2 unnumbered">
<h2>How parallel processing works<a class="anchor" aria-label="anchor" href="#how-parallel-processing-works"><i class="fas fa-link"></i></a>
</h2>
<p>This section provides an overview of how the functions <code><a href="https://rdrr.io/pkg/sits/man/sits_classify.html">sits_classify()</a></code>, <code><a href="https://rdrr.io/pkg/sits/man/sits_smooth.html">sits_smooth()</a></code> and <code><a href="https://rdrr.io/pkg/sits/man/sits_label_classification.html">sits_label_classification()</a></code> process images in parallel. To achieve efficiency, <code>sits</code> implements a fault tolerant multitasking procedure for big EO data classification. Users are not burdened with the need to learn how to do multiprocessing. Thus, their learning curve is shortened. Image classification in <code>sits</code> is done by a cluster of independent workers linked to a virtual machine. To avoid communication overhead, all large payloads are read and stored independently; direct interaction between the main process and the workers is kept at a minimum.</p>
<p>The classification procedure benefits from the fact that most images available in cloud collections are stored as COGs (cloud-optimized Geotiff). COGs are a regular GeoTIFF files organized in regular square blocks to improve visualization and access for large data sets. Thus, data requests can be optimized to access only portions of the images. All cloud services supported by <code>sits</code> use COG files. The classification algorithm in <code>sits</code> uses COGs to ensure optimal data access, reducing I/O demand as much as possible.</p>
<p>The approach for parallel processing in <code>sits</code>, depicted in the figure below, has the following steps:</p>
<ol style="list-style-type: decimal">
<li>Based on the block size of individual COG files, calculate the size of each chunk that has to be loaded in memory, considering the number of bands and the length of the timeline. Chunk access is optimized for efficient transfer of data blocks.</li>
<li>Divide the total memory available by the chunk size to find out how many processes can be run in parallel.</li>
<li>Each core processes a chunk and produces a subset of the result.</li>
<li>Repeat the process until all chunks in the cube have been processed.</li>
<li>Check that subimages have been produced correctly. If there is a problem with one or more subimages, run a failure recovery procedure to ensure all data is processed.</li>
<li>After all subimages are generated, join them to obtain the result.</li>
</ol>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-119"></span>
<img src="images/sits_parallel.png" alt="Parallel processing in sits (source: Simoes et al.,2021)." width="90%" height="90%"><p class="caption">
Figure 70: Parallel processing in sits (source: Simoes et al.,2021).
</p>
</div>
<p>This approach has many advantages. It works in any virtual machine that supports R and has no dependencies on proprietary software. Processing is done in a concurrent and independent way, with no communication between workers. Failure of one worker does not cause failure of the big data processing. The software is prepared to resume classification processing from the last processed chunk, preventing against failures such as memory exhaustion, power supply interruption, or network breakdown.</p>
<p>To reduce processing time, it is necessary to adjust <code><a href="https://rdrr.io/pkg/sits/man/sits_classify.html">sits_classify()</a></code>, <code><a href="https://rdrr.io/pkg/sits/man/sits_smooth.html">sits_smooth()</a></code>, and <code><a href="https://rdrr.io/pkg/sits/man/sits_label_classification.html">sits_label_classification()</a></code> according to the capabilities of the host environment. The <code>memsize</code> parameter controls the size of the main memory (in GBytes) to be used for classification. A practical approach is to set <code>memsize</code> to the maximum memory available in the virtual machine for classification and to chose <code>multicores</code> as the largest number of cores available. Based on the memory available and the size of blocks in COG files, <code>sits</code> will access the images in an optimized way. In this way, <code>sits</code> tries to ensure best possible use of the available resources.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="machine-learning-for-data-cubes.html">Machine Learning for Data Cubes</a></div>
<div class="next"><a href="bayesian-smoothing-for-post-processing.html">Bayesian smoothing for post-processing</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#image-classification-in-data-cubes">Image Classification in Data Cubes</a></li>
<li><a class="nav-link" href="#training-the-classification-model">Training the classification model</a></li>
<li><a class="nav-link" href="#building-a-data-cube">Building a data cube</a></li>
<li><a class="nav-link" href="#training-a-deep-learning-model">Training a deep learning model</a></li>
<li><a class="nav-link" href="#classification-using-parallel-processing">Classification using parallel processing</a></li>
<li><a class="nav-link" href="#map-reclassification">Map Reclassification</a></li>
<li><a class="nav-link" href="#how-parallel-processing-works">How parallel processing works</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong><strong>sits</strong>: Satellite Image Time Series Analysis on Earth Observation Data Cubes</strong>" was written by Gilberto Camara, Rolf Simoes, Felipe Souza, Charlotte Pelletier, Alber Sanchez, Pedro Ribeiro Andrade, Karine Ferreira, Gilberto Queiroz. It was last built on 2023-04-05.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
